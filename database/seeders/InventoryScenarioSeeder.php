<?php

namespace Database\Seeders;

use Illuminate\Database\Seeder;
use Illuminate\Support\Facades\Schema;
use Illuminate\Support\Facades\DB;
use App\Models\Item;
use App\Models\Store;
use App\Models\Employee;
use App\Models\Department;
use App\Models\Register;
use App\Models\RegisterPage;
use App\Models\CustodyAuditBase;
use App\Models\InventoryAudit;
use App\Models\User;
use App\Models\Category;
use App\Models\StoreItemMapping;
use Illuminate\Support\Facades\Hash;

class InventoryScenarioSeeder extends Seeder
{
    public function run()
    {
        // 1. Clean Slate
        Schema::disableForeignKeyConstraints();
        InventoryAudit::truncate();
        CustodyAuditBase::truncate();
        StoreItemMapping::truncate();
        Schema::enableForeignKeyConstraints();

        // 2. Setup Prerequisites
        $register = Register::firstOrCreate([
            "register_name" => "سجل الجرد السنوي",
        ]);

        $defaultDept = Department::firstOrCreate(["name" => "الإدارة العامة"]);

        // 3. The Dataset
        // FIXED: Changed "مخزن رئيسى" to "مخزن رئيسي" (Ya instead of Alef Maqsura)
        $rows = [
            // --- الادوات الكتابية (Stationery) ---
            [
                "باكيت ورق ملون لصق",
                "عدد",
                320,
                "جديد",
                274,
                18.0,
                "محسن شعبان",
                1,
                "الأدوات الكتابية",
                "مخزن رئيسي", // Fixed typo
                "1*3",
            ],
            [
                "ورق تصوير 3e",
                "عدد",
                65,
                "جديد",
                59,
                67.7,
                "محسن شعبان",
                3,
                "الأدوات الكتابية",
                "مخزن رئيسي", // Fixed typo
                "3*3",
            ],
            [
                "دوسية دوبلكس ورق",
                "عدد",
                350,
                "جديد",
                350,
                0.57,
                "محسن شعبان",
                8,
                "الأدوات الكتابية",
                "مخزن رئيسي", // Fixed typo
                "8*3",
            ],
            [
                "سولتيب شفاف 1.5",
                "عدد",
                22,
                "جديد",
                22,
                2.5,
                "محسن شعبان",
                9,
                "الأدوات الكتابية",
                "مخزن رئيسي", // Fixed typo
                "9*3",
            ],
            [
                "ظرف ذاتى a4بنى",
                "عدد",
                40,
                "جديد",
                40,
                0.7,
                "محسن شعبان",
                10,
                "الأدوات الكتابية",
                "مخزن رئيسي", // Fixed typo
                "10*3",
            ],
            [
                "ظرف 2/1 باكو e 4",
                "عدد",
                350,
                "جديد",
                350,
                0.37,
                "محسن شعبان",
                11,
                "الأدوات الكتابية",
                "مخزن رئيسي", // Fixed typo
                "11*3",
            ],
            [
                "اكلاسير 4سم",
                "عدد",
                400,
                "جديد",
                582,
                51.0,
                "محسن شعبان",
                12,
                "الأدوات الكتابية",
                "مخزن رئيسي", // Fixed typo
                "12*3",
            ],
            [
                "كيس a3 دوبل فلو سكاب",
                "عدد",
                250,
                "جديد",
                250,
                0.7,
                "محسن شعبان",
                13,
                "الأدوات الكتابية",
                "مخزن رئيسي", // Fixed typo
                "13*3",
            ],
            [
                "ظرف امريكانى",
                "عدد",
                100,
                "جديد",
                100,
                0.5,
                "محسن شعبان",
                14,
                "الأدوات الكتابية",
                "مخزن رئيسي", // Fixed typo
                "14*3",
            ],
            [
                "قلم فلوماستر سن عريض",
                "عدد",
                216,
                "جديد",
                109,
                2.75,
                "محسن شعبان",
                15,
                "الأدوات الكتابية",
                "مخزن رئيسي", // Fixed typo
                "15*3",
            ],
            [
                "حافظة اسطوانه 120 جيب",
                "عدد",
                50,
                "جديد",
                50,
                75.0,
                "محسن شعبان",
                20,
                "الأدوات الكتابية",
                "مخزن رئيسي", // Fixed typo
                "20*3",
            ],
            [
                "ورق تصوير a4",
                "رزمة",
                950,
                "جديد",
                872,
                180.0,
                "محسن شعبان",
                178,
                "الأدوات الكتابية",
                "مخزن رئيسي", // Fixed typo
                "178*3",
            ],
            [
                "ورق مسطر مفرد",
                "رزمة",
                30,
                "جديد",
                30,
                17.6,
                "محسن شعبان",
                23,
                "الأدوات الكتابية",
                "مخزن رئيسي", // Fixed typo
                "23*3",
            ],
            [
                "قلم رصاص",
                "عدد",
                110,
                "جديد",
                110,
                4.0,
                "محسن شعبان",
                127,
                "الأدوات الكتابية",
                "مخزن رئيسي", // Fixed typo
                "127*3",
            ],
            [
                "حافظة شفاف",
                "عدد",
                2700,
                "جديد",
                1600,
                4.0,
                "محسن شعبان",
                152,
                "الأدوات الكتابية",
                "مخزن رئيسي", // Fixed typo
                "152*3",
            ],
            [
                "حافظة بكبسول",
                "عدد",
                3552,
                "جديد",
                3552,
                6.5,
                "محسن شعبان",
                144,
                "الأدوات الكتابية",
                "مخزن رئيسي", // Fixed typo
                "144*3",
            ],
            [
                "سوليتب عريض",
                "عدد",
                82,
                "جديد",
                40,
                20.5,
                "محسن شعبان",
                185,
                "الأدوات الكتابية",
                "مخزن رئيسي", // Fixed typo
                "185*3",
            ],
            [
                "ختامه",
                "عدد",
                199,
                "جديد",
                132,
                20.0,
                "محسن شعبان",
                29,
                "الأدوات الكتابية",
                "مخزن رئيسي", // Fixed typo
                "29*3",
            ],

            // --- الدفاتر المالية (Financial Books) ---
            [
                "دفتر ايصالات اصل+صورة",
                "عدد",
                60,
                "جديد",
                60,
                27.0,
                "محسن شعبان",
                1,
                "الدفاتر المالية",
                "مخزن رئيسي", // Fixed typo
                "1*1",
            ],
            [
                "كعب دفتر 33ع.ح 200 قسيمة",
                "عدد",
                23,
                "جديد",
                23,
                0.0,
                "محسن شعبان",
                2,
                "الدفاتر المالية",
                "مخزن رئيسي", // Fixed typo
                "2*1",
            ],
            [
                "نموذج 1 مخازن",
                "عدد",
                37,
                "جديد",
                37,
                16.0,
                "محسن شعبان",
                4,
                "الدفاتر المالية",
                "مخزن رئيسي", // Fixed typo
                "4*1",
            ],
            [
                "كعب استمارة 33 ع.ح 40 قسيمة",
                "عدد",
                1,
                "جديد",
                1,
                11.0,
                "محسن شعبان",
                5,
                "الدفاتر المالية",
                "مخزن رئيسي", // Fixed typo
                "5*1",
            ],
            [
                "كعب استمارة 37 ع.ح 50 قسيمة",
                "عدد",
                274,
                "جديد",
                274,
                0.0,
                "محسن شعبان",
                6,
                "الدفاتر المالية",
                "مخزن رئيسي", // Fixed typo
                "6*1",
            ],
            [
                "دفتر استمارة 33 ع ح 300 قسيمة",
                "عدد",
                6,
                "جديد",
                6,
                44.0,
                "محسن شعبان",
                8,
                "الدفاتر المالية",
                "مخزن رئيسي", // Fixed typo
                "8*1",
            ],
            [
                "استمارة 9 ع ح",
                "عدد",
                3,
                "جديد",
                3,
                17.0,
                "محسن شعبان",
                12,
                "الدفاتر المالية",
                "مخزن رئيسي", // Fixed typo
                "12*1",
            ],
            [
                "دفتر اخطار شيكات +استمارة49ع.ح",
                "عدد",
                3,
                "جديد",
                3,
                21.0,
                "محسن شعبان",
                30,
                "الدفاتر المالية",
                "مخزن رئيسي", // Fixed typo
                "30*1",
            ],
            [
                "دفتر اذون تسوية 150 اذن استمارة 125",
                "عدد",
                3,
                "جديد",
                3,
                34.0,
                "محسن شعبان",
                31,
                "الدفاتر المالية",
                "مخزن رئيسي", // Fixed typo
                "31*1",
            ],
            [
                "كعب دفتر بونات مصر للبترول",
                "عدد",
                6,
                "جديد",
                6,
                0.0,
                "محسن شعبان",
                33,
                "الدفاتر المالية",
                "مخزن رئيسي", // Fixed typo
                "33*1",
            ],

            // --- Mixed / Others ---
            [
                "استمارة 37 ع ح",
                "عدد",
                12,
                "جديد",
                12,
                15.4,
                "زينات صدقي",
                14,
                "الدفاتر المالية",
                "مخزن رئيسي", // Fixed typo
                "14*1",
            ],
            [
                "ورق رسم بيانى",
                "عدد",
                140,
                "جديد",
                140,
                0.43,
                "محسن شعبان",
                15,
                "الدفاتر المالية",
                "مخزن رئيسي", // Fixed typo
                "15*1",
            ],
            [
                "علبة دبوس دباسة ماكيته تصوير توشيبا",
                "عدد",
                20,
                "جديد",
                20,
                19.5,
                "محسن شعبان",
                30,
                "الأدوات الكتابية",
                "مخزن رئيسي", // Fixed typo
                "30*3",
            ],
            [
                "دوسيه بلاستيك بكعب",
                "عدد",
                2850,
                "جديد",
                2850,
                23.5,
                "محسن شعبان",
                31,
                "الأدوات الكتابية",
                "مخزن رئيسي", // Fixed typo
                "31*3",
            ],
            [
                "ظرف لاصق ذاتى a3",
                "عدد",
                2280,
                "جديد",
                2280,
                5.0,
                "محسن شعبان",
                32,
                "الأدوات الكتابية",
                "مخزن رئيسي", // Fixed typo
                "32*3",
            ],
            [
                "ظرف لاصق ذاتى a4",
                "عدد",
                1460,
                "جديد",
                1460,
                2.5,
                "محسن شعبان",
                160,
                "الأدوات الكتابية",
                "مخزن رئيسي", // Fixed typo
                "160*3",
            ],
            [
                "قلم فوسفورى",
                "عدد",
                84,
                "جديد",
                84,
                28.0,
                "محسن شعبان",
                147,
                "الأدوات الكتابية",
                "مخزن رئيسي", // Fixed typo
                "147*3",
            ],
            [
                "دبوس دباسة v24",
                "عدد",
                386,
                "جديد",
                386,
                14.0,
                "محسن شعبان",
                37,
                "الأدوات الكتابية",
                "مخزن رئيسي", // Fixed typo
                "37*3",
            ],
            [
                "سلوتيب صغير 3 سم",
                "عدد",
                187,
                "جديد",
                79,
                3.0,
                "محسن شعبان",
                177,
                "الأدوات الكتابية",
                "مخزن رئيسي", // Fixed typo
                "177*3",
            ],
            [
                "ظرف ابيض تجارى لاصق ذاتى",
                "عدد",
                4600,
                "جديد",
                4600,
                5.0,
                "محسن شعبان",
                39,
                "الأدوات الكتابية",
                "مخزن رئيسي", // Fixed typo
                "39*3",
            ],

            // --- Used Items (مستعمل) ---
            [
                "دفتر 33 ع.ج 80 قسيمه",
                "عدد",
                10,
                "مستعمل",
                10,
                32.0,
                "محسن شعبان",
                40,
                "الدفاتر المالية",
                "مخزن رئيسي", // Fixed typo
                "40*3",
            ],
            [
                "كعب استمارة 33 ع.ج 80 قسيمة",
                "عدد",
                9,
                "مستعمل",
                9,
                0.0,
                "محسن شعبان",
                42,
                "الدفاتر المالية",
                "مخزن رئيسي", // Fixed typo
                "42*1",
            ],

            // --- More Stationery ---
            [
                "اكلاسير 8سم",
                "عدد",
                450,
                "جديد",
                253,
                51.0,
                "محسن شعبان",
                44,
                "الأدوات الكتابية",
                "مخزن رئيسي", // Fixed typo
                "44*1",
            ],
            [
                "لوح رسم ستون",
                "عدد",
                75,
                "جديد",
                75,
                15.86,
                "محسن شعبان",
                4,
                "الأدوات الكتابية",
                "مخزن رئيسي", // Fixed typo
                "4*3",
            ],
            [
                "قلم كوريكتور",
                "عدد",
                72,
                "جديد",
                62,
                57.0,
                "محسن شعبان",
                5,
                "الأدوات الكتابية",
                "مخزن رئيسي", // Fixed typo
                "5*3",
            ],
            [
                "فرخ بريستول (240 جرام أبيض)",
                "عدد",
                5200,
                "جديد",
                3750,
                13.25,
                "محسن شعبان",
                106,
                "الأدوات الكتابية",
                "مخزن رئيسي", // Fixed typo
                "106*3",
            ],
            [
                "علبة قلم بوني بول",
                "عدد",
                60,
                "جديد",
                60,
                547.2,
                "محسن شعبان",
                102,
                "الأدوات الكتابية",
                "مخزن رئيسي", // Fixed typo
                "102*3",
            ],
            [
                "علبة صمغ سائل",
                "عدد",
                53,
                "جديد",
                53,
                237.6,
                "محسن شعبان",
                128,
                "الأدوات الكتابية",
                "مخزن رئيسي", // Fixed typo
                "128*3",
            ],
            [
                "ظرف C4 بني",
                "عدد",
                1000,
                "جديد",
                1000,
                3.0,
                "محسن شعبان",
                129,
                "الأدوات الكتابية",
                "مخزن رئيسي", // Fixed typo
                "129*3",
            ],
            [
                "علبة دبوس دباسة 30%10 كبيرة",
                "عدد",
                195,
                "جديد",
                195,
                47.75,
                "محسن شعبان",
                130,
                "الأدوات الكتابية",
                "مخزن رئيسي", // Fixed typo
                "130*3",
            ],
            [
                "اكلاسير ميمو 4سم",
                "عدد",
                200,
                "جديد",
                200,
                65.4,
                "محسن شعبان",
                131,
                "الأدوات الكتابية",
                "مخزن رئيسي", // Fixed typo
                "131*3",
            ],
            [
                "علبة كلبس ورق مقاس 50",
                "عدد",
                50,
                "جديد",
                50,
                26.4,
                "محسن شعبان",
                133,
                "الأدوات الكتابية",
                "مخزن رئيسي", // Fixed typo
                "133*3",
            ],
            [
                "علبة كلبس ورق مقاس 30",
                "عدد",
                20,
                "جديد",
                20,
                21.6,
                "محسن شعبان",
                135,
                "الأدوات الكتابية",
                "مخزن رئيسي", // Fixed typo
                "135*3",
            ],
            [
                "ورق سيمالوج",
                "عدد",
                2300,
                "جديد",
                2300,
                0.0,
                "محسن شعبان",
                137,
                "الأدوات الكتابية",
                "مخزن رئيسي", // Fixed typo
                "137*3",
            ],
            [
                "دبوس بفرعين",
                "عدد",
                10,
                "جديد",
                10,
                0.0,
                "محسن شعبان",
                138,
                "الأدوات الكتابية",
                "مخزن رئيسي", // Fixed typo
                "138*3",
            ],
            [
                "قلم سبورة",
                "عدد",
                107,
                "جديد",
                57,
                12.75,
                "محسن شعبان",
                165,
                "الأدوات الكتابية",
                "مخزن رئيسي", // Fixed typo
                "165*3",
            ],
        ];

        // 4. Processing Loop
        foreach ($rows as $row) {
            $itemName = $row[0];
            $unit = $row[1];
            $observedQty = $row[2];
            $state = $row[3];
            $bookedQty = $row[4];
            $price = $row[5];
            $empName = $row[6];
            $categoryId = $row[7];
            $storeName = $row[8];
            $custodyType = $row[9];
            $pageNoStr = $row[10];

            $pageNo = (int) filter_var($pageNoStr, FILTER_SANITIZE_NUMBER_INT);

            // A. Ensure Employee Exists
            $employee = Employee::firstOrCreate(
                ["name" => $empName],
                [
                    "job_title" => "أمين عهده",
                    "ssn" => rand(100000000, 999999999),
                    "user_id" => User::firstOrCreate(
                        ["email" => "user_" . rand(1000, 9999) . "@test.com"],
                        ["name" => $empName, "password" => Hash::make("123")],
                    )->id,
                    "department_id" => $defaultDept->id,
                ],
            );

            // B. Ensure Store Exists
            $store = Store::firstOrCreate(
                ["name" => $storeName],
                [
                    "classification" => "مستديم",
                    "custody_type" => $custodyType,
                    "responsible_employee_id" => $employee->id,
                ],
            );

            // C. Create Item
            $item = Item::firstOrCreate(
                ["item_name" => $itemName],
                [
                    "unit" => $unit,
                    "barcode" => "ITM-" . $categoryId . "-" . rand(100, 999),
                    "description" => "صنف مخزني: " . $storeName,
                ],
            );

            // D. Ensure Category Exists with Correct Type Logic
            // FIXED: Use the store's classification as the category type
            // This ensures logic in ReportController matches:
            // ->where('stores.classification', $category->type)
            $category = Category::firstOrCreate(
                ['id' => $categoryId],
                [
                    'cat_name' => 'بند ' . $categoryId,
                    'type' => $store->classification // Dynamic assignment
                ]
            );

            // E. Create Store-Item Mapping
            StoreItemMapping::firstOrCreate(
                [
                    'store_id' => $store->id,
                    'item_id' => $item->id
                ],
                [
                    'category_id' => $category->id
                ]
            );

            // F. Ensure Register Page Exists
            RegisterPage::firstOrCreate(
                [
                    "register_id" => $register->id,
                    "page_number" => $pageNo,
                ],
                [
                    "store_id" => $store->id,
                ],
            );

            // G. Create Custody Audit Base
            $auditBase = CustodyAuditBase::create([
                "date" => now(),
                "unit_price" => $price,
                "register_id" => $register->id,
                "page_no" => $pageNo,
                "item_id" => $item->id,
                "audit_type" => "Inventory",
            ]);

            // H. Create Inventory Audit
            InventoryAudit::create([
                "id" => $auditBase->id,
                "store_id" => $store->id,
                "observed_quantity" => $observedQty,
                "booked_quantity" => $bookedQty,
                "observed_state" => $state,
                "booked_state" => "جديد",
            ]);
        }
    }
}
